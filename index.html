<!DOCTYPE html>
<html>
  <head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-160301714-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-160301714-2');
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
    <!-- <script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=eeaf5c13b3e9573d87dd44a626f38d09"></script> -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=eeaf5c13b3e9573d87dd44a626f38d09"></script>
    <link href="https://fonts.googleapis.com/css?family=Overlock:900&display=swap" rel="stylesheet">
    <script src="distance.js"></script>
    <link href="stylec.css" rel="stylesheet">
    <title>2km Mask</title>
  </head>
  <body>
<header class="header">
    <div class="header__title">
        <span>2mask.co ğŸ˜·</span>
        <!-- <div>2km ë‚´ì˜ ê³µì ë§ˆìŠ¤í¬ ì¬ê³  ì°¾ê¸°</div> -->
    </div>
    <div class='header__updatedAt'>ë§ˆì§€ë§‰ ê°±ì‹ <br><span></span></div>
    <div class='header-tabs'>
        <div class="header-tabs__tab1 header-tabs__tabs">ë¦¬ìŠ¤íŠ¸<div class="header-tabs__tabBar" style></div></div>
        <div class="header-tabs__tab2 header-tabs__tabs">ì§€ë„ë³´ê¸°<div class="header-tabs__tabBar" style="display: none;"></div></div>
        <div class="header-tabs__tab3 header-tabs__tabs">ì•ˆë‚´<div class="header-tabs__tabBar" style="display: none;"></div></div>
        <div class="header-tabs__option header-tabs__tabs">ì¬ê³ ìˆìŒ</div>
    </div>
</header>
<main>
    <div id="tabList">
        <ul></ul>
        <div class="loader">Loading...</div>
        <div id="notice" class="notice__alert">
            <div>
            â° ë§ˆìŠ¤í¬ ì¬ê³  í˜„í™©ì€ ì‹¤ì œ íŒë§¤ì²˜ í˜„í™©ê³¼ 5-10ë¶„ ì •ë„ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            ğŸ™ğŸ¼ ê³µì  ë§ˆìŠ¤í¬ ì„œë¹„ìŠ¤ ì‹œ ì–´ë ¤ìš´ í™˜ê²½ì—ì„œë„ ì¼ì„ ì—ì„œ ê³µí—Œí•´ ì£¼ì‹œëŠ” ì•½ì‚¬ë‹˜, ìš°ì²´êµ­ ì¢…ì‚¬ìë¶„, í•˜ë‚˜ë¡œ ë§ˆíŠ¸(ì˜ˆì •)ë¶„ë“¤ê»˜ë„ ê°ì‚¬ì™€ ì‘ì› ë“œë¦½ë‹ˆë‹¤.
            </div>
            <div class="notice__footer">ğŸ„ í˜„ì¬ ë°ì´í„° ì œê³µì²˜ì˜ ì„œë¹„ìŠ¤ ë° ì´ ì„œë¹„ìŠ¤ëŠ” ë² íƒ€ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br>
            ğŸ“¡ ë°ì´í„° ì¶œì²˜ : ì‹¬í‰ì›â€§ì •ë³´í™”ì§„í¥ì›(ê³µê³µë°ì´í„°í¬í„¸)<br>
            ğŸ™‚ <a href="mailto:sungi.kim@gmail.com?Subject=2kmMask">by tim</a></div>
        </div>
    </div>
    <div id="tabMap">
        <div id="map"></div>
        <div class="mapWaiting" style="display: none;">ì•„ì§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ë¦¬ìŠ¤íŠ¸ê°€ í‘œì‹œëœ í›„ ì§€ë„ë¥¼ ë´ì£¼ì„¸ìš”.</div>
    </div>
    <div id="tabInfo">
        <div class="tabInfo__notice">
            <div>
            ğŸ§­ 2km ë‚´ì˜ ê³µì ë§ˆìŠ¤í¬ ì¬ê³ ë¥¼ ì°¾ì•„ì¤ë‹ˆë‹¤.<br><br>
            â° ë§ˆìŠ¤í¬ ì¬ê³  í˜„í™©ì€ ì‹¤ì œ íŒë§¤ì²˜ í˜„í™©ê³¼ 5-10ë¶„ ì •ë„ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><br>
            ğŸ™ğŸ¼ ê³µì  ë§ˆìŠ¤í¬ ì„œë¹„ìŠ¤ ì‹œ ì–´ë ¤ìš´ í™˜ê²½ì—ì„œë„ ì¼ì„ ì—ì„œ ê³µí—Œí•´ ì£¼ì‹œëŠ” ì•½ì‚¬ë‹˜, ìš°ì²´êµ­ ì¢…ì‚¬ìë¶„, í•˜ë‚˜ë¡œ ë§ˆíŠ¸(ì˜ˆì •)ë¶„ë“¤ê»˜ë„ ê°ì‚¬ì™€ ì‘ì› ë“œë¦½ë‹ˆë‹¤.
            </div>
            <div class="notice__footer">ğŸ„ í˜„ì¬ ë°ì´í„° ì œê³µì²˜ì˜ ì„œë¹„ìŠ¤ ë° ì´ ì„œë¹„ìŠ¤ëŠ” ë² íƒ€ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br>
            ğŸ“¡ ë°ì´í„° ì¶œì²˜ : ì‹¬í‰ì›â€§ì •ë³´í™”ì§„í¥ì›(ê³µê³µë°ì´í„°í¬í„¸)<br>
            ğŸ™‚ <a href="mailto:sungi.kim@gmail.com?Subject=2kmMask">by tim</a></div>
        </div>
    </div>
</main>
<div class="restore">
    í˜„ì¬ ìœ„ì¹˜ë¡œ ëŒì•„ê°€ê¸° 
</div>
<div class="overlay">
</div>
<div id="sheetList" class="overlay-bottomSheet"></div>
<div id="sheetMap" class="overlay-bottomSheet"></div>

<script>
moment.locale("ko");
var aa =moment("2020/03/12 04:47:00", "YYYY/MM/DD HH:mm:ss").fromNow();
console.log(aa)

var alat
var alng
var LatLng = [], localLatLng = [], mapLatLng = []
var listArr = []
$(document).ready(function () {
    $('html, body').animate({
        scrollTop: ($('.header').offset().top)
    }, 500);    
    setTimeout(function(){ 
        $("#notice").removeClass("notice__alert")
    }, 1000);
});

var stickyHeaderVal = $(".header-tabs").offset().top;
window.onscroll = function() {
    if (window.pageYOffset > stickyHeaderVal) {
    $(".header-tabs").addClass("sticky")
  } else {
    $(".header-tabs").removeClass("sticky")
  }  
};

async function getGeo() {
    return new Promise((resolve, reject) => {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                geo = [position.coords.latitude,position.coords.longitude]
                localLatLng = geo
                LatLng = geo
                return resolve(geo)
            }, function(error) {
                alert("í˜„ì¬ìœ„ì¹˜ë¥¼ ë°›ì•„ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
            });
        } else {
            alert("í˜„ì¬ìœ„ì¹˜ì°¾ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì € ì…ë‹ˆë‹¤. í˜¹ì€ ì„¤ì •ì—ì„œ ìœ„ì¹˜ì •ë³´ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”");
        }
    })
}


let request = new XMLHttpRequest();

async function getData(base) {
    let geoArr
    // let geoArr = await getGeo()
    if (base) {
        geoArr = base
        console.log("base")
    }
    else {
        geoArr = await getGeo()
        console.log("local")
    }
    // switch(base) {
    //     case "": geoArr = await getGeo();break;
    //     case "map": geoArr = mapLatLng;break;
    // }
    let url = `https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByGeo/json?lat=${geoArr[0]}&lng=${geoArr[1]}&m=2000`
    let response = await fetch(url)
    let data = await response.json()
    let result = data.stores
    return result
}

getData()
    .then(list => {
        renderData(list)
    })

function renderData(list) {
    $("document").find("li").remove()
    $(".loader").hide()
        for(i in list) {
            let distance = Math.round(LatLngDist(localLatLng[0],localLatLng[1],list[i].lat,list[i].lng) * 100) / 100
            let stat, statCat, typeStr
            switch(list[i].remain_stat) {
                case "plenty": stat = "100ê°œ ì´ìƒ";statCat = 4;break;
                case "some": stat = "30~100ê°œ";statCat = 3;break;
                case "few": stat = "2~30ê°œ";statCat = 2;break;
                case "empty": stat = "ì—†ìŒ";statCat = 1;break;
                default: stat = "ì •ë³´ì—†ìŒ";statCat = 0;break;
            }
            switch(list[i].type) {
                case "01": typeStr = "ì•½êµ­";break;
                case "02": typeStr = "ìš°ì²´êµ­";break;
                case "03": typeStr = "ë†í˜‘";break;
                default: typeStr = "ì •ë³´ì—†ìŒ";break;
            }
            list[i]["distance"] = distance
            list[i]["stat"] = stat
            list[i]["statCat"] = statCat
            list[i]["typeStr"] = typeStr

            if (list[i].stock_at) {
                list[i]["stockTime"] = moment(list[i].stock_at, "YYYY/MM/DD HH:mm:ss").fromNow()
            }
            else {list[i]["stockTime"] = 'ì •ë³´ì—†ìŒ'}
        }
        list.sort(function(a, b) {
            return a["distance"] - b["distance"];
        });
        $("ul").empty()
        for(i in list) {
            let card = `<li data-statcat="${list[i].statCat}" data-name="${list[i].name}" data-lat="${list[i].lat}" data-lng="${list[i].lng}" data-addr="${list[i].addr}" data-distance="${list[i].distance}" data-stocktime="${list[i].stockTime}" data-stat="${list[i].stat}">
                            <div class="card-header">
                                <div class="card-header__name">${list[i].name}</div>
                                <div class="card-header__distance">${list[i].distance}<span>km</span></div>
                            </div>
                            <div class="card-addr">${list[i].addr}</div>
                            <div class="card-footer">
                                <div class="card-footer-stat">
                                    <div class="card-footer-stat__bar"></div>
                                    <div class="card-footer-stat__text">ì¬ê³  : ${list[i].stat}</div>
                                </div>
                                <div class="card-footer__stockAt">ë¯¸ìë§‰ ì…ê³  :  ${list[i].stockTime}</div>
                            </div>
                        </li>`
            $("ul").append(card);
        }
        $("li").each(function(){
            switch($(this).data("statcat")) {
                case 0 : $(this).addClass('none');break;
                case 1 : $(this).addClass('none');break;
                case 2 : $(this).find('.card-footer-stat__bar').addClass("red");break;
                case 3 : $(this).find('.card-footer-stat__bar').addClass("yellow");break;
                case 4 : $(this).find('.card-footer-stat__bar').addClass("green");break;
            }

        })
        listArr = list
        for (i in list) {
            if(list[0].created_at){
                $(".header__updatedAt").find("span").text(list[0].created_at.substr(0,16))
                break;
            }
        }
        $("li").click(function(){
            let name = $(this).data("name")
            let distance = $(this).data("distance")
            let stat = $(this).data("stat")
            let addr = $(this).data("addr")
            let stockTime = $(this).data("stocktime")
            let lat = $(this).data("lat")
            let lng = $(this).data("lng")
            let color
            switch($(this).data("statcat")) {
                case 0 : color = "gray";break;
                case 1 : color = "gray";break;
                case 2 : color = "red";break;
                case 3 : color = "yellow";break;
                case 4 : color = "green";break;
            }
            let kakaomap = `kakaomap://search?q=${name}&p=${lat},${lng}`
            let navermap = encodeURI("nmap://search?query=" + name)
            $(".overlay").show();
            $("#sheetList").html(sheetHTML(name,distance,addr,color,stat,stockTime))
            $("#sheetList").show();
            $("#sheetList").find('.btnKakao').data('url', kakaomap);
            $("#sheetList").find('.btnNaver').data('url', navermap);
            $("#sheetList").append("<div id='miniMap'></div>");
            miniMap(lat,lng,color,stat)
            $(".btnMap").click(function() {
                let url = $(this).data('url')
                location.href = url
            })
        })
}

$(".header-tabs__tab2").click(function() {
    $("#tabMap").siblings().hide()
    $("#tabMap").show()
    if(listArr[0]) {
        $(".header-tabs__tabs").find(".header-tabs__tabBar").hide()
        $(this).find(".header-tabs__tabBar").show()
        $("header").addClass("header__moveTop")
        renderMap(listArr)
    }
    else{
        $(".mapWaiting").show()
    }
})
$(".header-tabs__tab1").click(function() {
    $("#tabList").siblings().hide()
    $("#tabList").show()
    $(".header-tabs__tabs").find(".header-tabs__tabBar").hide()
    $(this).find(".header-tabs__tabBar").show()
    $("header").removeClass("header__moveTop")
    $("#map").empty()
})
$(".header-tabs__tab3").click(function() {
    $("#tabInfo").siblings().hide()
    $("#tabInfo").show()
    $(".header-tabs__tabs").find(".header-tabs__tabBar").hide()
    $(this).find(".header-tabs__tabBar").show()
    $("header").removeClass("header__moveTop")
    $("#map").empty()
})


function showSheet(dd) {
    $(".overlay").show();
    $("#sheetMap").show();
    console.log(dd)
    let name = dd.data("name")
    let distance = dd.data("distance")
    let stat = dd.data("stat")
    let addr = dd.data("addr")
    let stockTime = dd.data("stocktime")
    let lat = dd.data("lat")
    let lng = dd.data("lng")
    let color
    switch(dd.data("statcat")) {
        case 0 : color = "gray";break;
        case 1 : color = "gray";break;
        case 2 : color = "red";break;
        case 3 : color = "yellow";break;
        case 4 : color = "green";break;
    }

    $("#sheetMap").html(sheetHTML(name,distance,addr,color,stat,stockTime))
    let kakaomap = `kakaomap://search?q=${name}&p=${lat},${lng}`
    let navermap = encodeURI("nmap://search?query=" + name)
    $(".overlay").show();
    $("sheetMap").show();
    $("#sheetMap").find('.btnKakao').data('url', kakaomap);
    $("#sheetMap").find('.btnNaver').data('url', navermap);
    $(".btnMap").click(function() {
    let url = $(this).data('url')
    location.href = url
})
    
}

function sheetHTML(name,distance,addr,color,stat,stockTime){
    let sheet = `<div class="sheetMap__card">
        <div class="card-header">
            <div class="card-header__name">${name}</div>
            <div class="card-header__distance">${distance}<span>km</span></div>
        </div>
        <div class="card-addr">${addr}</div>
        <div class="card-footer">
            <div class="card-footer-stat">
                <div class="card-footer-stat__bar ${color}"></div>
                <div class="card-footer-stat__text">ì¬ê³  : ${stat}</div>
            </div>
            <div class="card-footer__stockAt">ë¯¸ìë§‰ ì…ê³  :  ${stockTime}</div>
        </div>
    </div>
    <div class="buttonGroup">
        <div class="btnKakao btnMap">ì¹´ì¹´ì˜¤ë§µ</div>
        <div class="btnNaver btnMap">ë„¤ì´ë²„ë§µ</div>
        </div>`
    return sheet
}

function miniMap(lat,lng,color,stat) {
    var points = [
        new kakao.maps.LatLng(localLatLng[0],localLatLng[1]),
        new kakao.maps.LatLng(lat,lng)
    ]
    var bounds = new kakao.maps.LatLngBounds()
    
    var mapContainer = document.getElementById('miniMap'), 
    mapOption = { 
        center: points[0],
        level: 3 
    }; 

    // í˜„ì¬ ìœ„ì¹˜ ì°ê¸°
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var content = `
        <div class ="map__currentPosition">ğŸ™‚</div>`  
    var customOverlay = new kakao.maps.CustomOverlay({
        position: points[0],
        content: content   
        });
    customOverlay.setMap(map);
    bounds.extend(points[0]);
    // í˜„ì¬ ìœ„ì¹˜ ì°ê¸° - ë

    var content = `
        <div class="map__label ${color}">${stat}</div>`
    var customOverlay = new kakao.maps.CustomOverlay({
        position: points[1],
        content: content   
        });
    customOverlay.setMap(map);
    bounds.extend(points[1]);

    
    map.setBounds(bounds);
}

function renderMap(list) {
    var mapContainer = document.getElementById('map'), 
    mapOption = { 
        center: new kakao.maps.LatLng(LatLng[0], LatLng[1]),
        level: 3 
    }; 

    // í˜„ì¬ ìœ„ì¹˜ ì°ê¸°
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var content = `
        <div class ="map__currentPosition">ğŸ™‚</div>`
    var position = new kakao.maps.LatLng(LatLng[0], LatLng[1]);  
    var customOverlay = new kakao.maps.CustomOverlay({
        position: position,
        content: content   
        });
    customOverlay.setMap(map);
    // í˜„ì¬ ìœ„ì¹˜ ì°ê¸° - ë

    // ëª¨ë“  ë§ˆì»¤ ì°ê¸°
    for(i in list) {
        let color
        switch(list[i].statCat) {
            case 0 : color = "gray";break;
            case 1 : color = "gray";break;
            case 2 : color = "red";break;
            case 3 : color = "yellow";break;
            case 4 : color = "green";break;
        }
        var content = `
            <div onclick="showSheet($(this))" class="map__label ${color}" data-lat="${list[i].lat}" data-lng="${list[i].lng}" data-name="${list[i].name}" data-statcat="${list[i].statCat}" data-stat="${list[i].stat}" data-stocktime="${list[i].stockTime}" data-distance="${list[i].distance}" data-addr="${list[i].addr}">${list[i].stat}</div>`
        var position = new kakao.maps.LatLng(list[i].lat, list[i].lng);  
        var customOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content   
            });
        customOverlay.setMap(map);
    }
    // ëª¨ë“  ë§ˆì»¤ ì°ê¸° - ë
    kakao.maps.event.addListener(map, 'zoom_changed', function() {    
        var level = map.getLevel();
        if(level > 4) {
            $(".map__label.gray").hide();
        }
        else {
            $(".map__label.gray").show()
        }
    })
    kakao.maps.event.addListener(map, 'dragend', function() {
            var latlng = map.getCenter()
            mapLatLng = [latlng.getLat(),latlng.getLng()]
            LatLng = mapLatLng
            getData(mapLatLng)
            .then(list => {
                renderData(list)
                renderMapUpdate(list, mapLatLng)
            })
            
            $(".restore").show()

    });
    function renderMapUpdate(updatelist, centerLatLng) {
        $(".map__label").remove()
        $(".map__currentPosition").remove()
        var content = `<div class ="map__currentPosition">ğŸ™‚</div>`
        var position = new kakao.maps.LatLng(centerLatLng[0], centerLatLng[1]);  
        map.setCenter(position);
        var customOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content   
            });
        customOverlay.setMap(map);
        // ëª¨ë“  ë§ˆì»¤ ì°ê¸°
        for(i in updatelist) {
            let color
            switch(updatelist[i].statCat) {
                case 0 : color = "gray";break;
                case 1 : color = "gray";break;
                case 2 : color = "red";break;
                case 3 : color = "yellow";break;
                case 4 : color = "green";break;
            }
            var content = `
                <div onclick="showSheet($(this))" class="map__label ${color}" data-lat="${updatelist[i].lat}" data-lng="${updatelist[i].lng}" data-name="${updatelist[i].name}" data-statcat="${updatelist[i].statCat}" data-stat="${updatelist[i].stat}" data-stocktime="${updatelist[i].stockTime}" data-distance="${updatelist[i].distance}" data-addr="${updatelist[i].addr}">${updatelist[i].stat}</div>`
            var position = new kakao.maps.LatLng(updatelist[i].lat, updatelist[i].lng);  
            var customOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: content   
                });
            customOverlay.setMap(map);
        }
        setTimeout(function(){
            var level = map.getLevel();
            if(level > 4) {
                $(".map__label.gray").hide();
            }
            else {
                $(".map__label.gray").show()
            }
        }, 1500);
        
        $(".restore").click(function() {
        getData()
            .then(list => {
                $("#map > div").remove()
                renderData(list)
                renderMap(list)
            })
            $(".restore").hide()
         })
        // ëª¨ë“  ë§ˆì»¤ ì°ê¸° - ë
    }
}


$(".overlay").click(function() {
    $(".overlay").hide();
    $(".overlay-bottomSheet").hide();
})


$(".header-tabs__option").click(function() {
    $(this).toggleClass("activate")
    $(".none").toggle();
    if($(this).hasClass("activate")) {
        $(".map__label.gray").hide();
    }
    else { $(".map__label.gray").show();}
    
})





</script>
  </body>
</html>
